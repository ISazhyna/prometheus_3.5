.PHONY: clean

VERSION := v1.0.0
IMAGE_TAG := myapp:$(VERSION)

# Define all valid combinations of $GOOS and $GOARCH
PLATFORMS := \
    linux/386 \
    linux/amd64 \
    linux/arm \
    linux/arm64 \
    darwin/amd64 \
    darwin/arm64 \
    windows/amd64 \
    windows/386

# Build targets for each platform
build: $(PLATFORMS)

$(PLATFORMS):
	@echo "Building $(IMAGE_TAG) for $@"
	@GOOS=$(word 1,$(subst /, ,$@)) GOARCH=$(word 2,$(subst /, ,$@)) \
		go build -o bin/$(basename $(IMAGE_TAG))-$@ -ldflags "-X main.version=$(VERSION)"

# Clean up
clean:
	@echo "Cleaning up"
	@rm -rf bin/*

# Remove newly created Docker image
clean-image:
	@echo "Removing Docker image $(IMAGE_TAG)"
	@docker rmi $(IMAGE_TAG)